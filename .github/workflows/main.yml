name: Cloud Resume DevSecOps Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  id-token: write # Required for OIDC handshake with AWS
  contents: read  # Required for checking out the code

jobs:
  # --- GATE 1: Security Scanning ---
  security_audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: IaC Security Scan (Checkov)
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure/
          framework: terraform
          soft_fail: false # Pipeline stops if high-risk issues are found

  # --- GATE 2: Infrastructure Deployment ---
  deploy_infra:
    needs: security_audit
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    # Define an output so the next job can read the URL
    outputs:
      api_endpoint: ${{ steps.tf_out.outputs.api_endpoint }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::009245114403:role/admin_role
          aws-region: us-east-1

      - name: Terraform Init & Apply
        working-directory: ./infrastructure
        run: |
          terraform init
          terraform apply -auto-approve

      - name: Get API URL Output
        id: tf_out
        working-directory: ./infrastructure
        # This grabs the URL from terraform and saves it to a GitHub Output variable
        run: echo "api_endpoint=$(terraform output -raw api_endpoint)" >> $GITHUB_OUTPUT

  # --- GATE 3: Frontend Sync ---
  deploy_frontend:
    needs: deploy_infra
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::009245114403:role/admin_role
          aws-region: us-east-1

      - name: Inject API URL into JS
        run: |
          # 1. Grab the URL passed from the previous job
          API_URL="${{ needs.deploy_infra.outputs.api_endpoint }}"
          
          # 2. Verify we got it (prints to log for debugging)
          echo "Injecting API URL: $API_URL"
          
          # 3. Use 'sed' to replace the placeholder in main.js
          sed -i "s|%%API_URL_PLACEHOLDER%%|$API_URL|g" js/main.js

      - name: S3 Sync
        # Ensure we sync the CURRENT directory (with the modified JS) to the bucket
        # Note: You need to replace 'your-bucket-name' if it's not dynamically fetched, 
        # but usually standard usage is to use the s3-sync action or aws cli directly.
        # Below is the AWS CLI method which is most reliable.
        run: |
          aws s3 sync . s3://aarondouglass.com --delete --exclude ".git/*" --exclude "infrastructure/*" --exclude ".github/*"

      - name: Invalidate CloudFront
        run: |
          # Finds the distribution ID for your domain and invalidates cache
          DIST_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?Aliases.Items!=null] | [?contains(Aliases.Items, 'aarondouglass.com')].Id" --output text)
          if [ ! -z "$DIST_ID" ]; then
            aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"
          fi